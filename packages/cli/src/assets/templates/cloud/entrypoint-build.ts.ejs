import { createRouter } from "@cloudnux/aws-cloud-provider/router";
import { awsCloudProvider } from "@cloudnux/aws-cloud-provider";
import {
    httpHandler,
    eventHandler,
    scheduleHandler,
    useCloudProvider,
    useCloudProvider
  } from "@cloudnux/cloud-sdk"; 

import * as src from "../../../packages/modules/<%=module%>/src";

useCloudProvider(awsCloudProvider);

const router = createRouter();

<%_ for(var [key,entry] of Object.entries(entries)) { _%>
    <%_ if(entry.trigger.type.toLowerCase() === "http") { _%>
        router.http(
             "<%= entry.trigger.options.method %>",
             "<%= entry.trigger.options.route %>",
             httpHandler(src["<%= entry.handler %>"]));
    <%_ } _%>

    <%_ if(entry.trigger.type.toLowerCase() === "schedule") { _%>
        router.schedule(
             "<%= entry.trigger.options.name %>",
             "<%= entry.trigger.options.cron %>",
             scheduleHandler(src["<%= entry.handler %>"]));
    <%_ } _%>

    <%_ if(entry.trigger.type.toLowerCase() === "event") { _%>
        router.event(
             "<%= entry.trigger.options.source %>",
             "<%= entry.trigger.options.sourceType %>",
             "<%= entry.trigger.options.filter %>",
             eventHandler(src["<%= entry.handler %>"]));
    <%_ } _%>

<%_ } _%>


export async function handler(event, context) {


    try {
        //await initialize();
        const output = await router.run(event, context);
        return output;
    } catch (error) {
        throw error;
    }
}